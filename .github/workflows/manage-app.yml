name: Manage App on VM

on:
    workflow_dispatch:
        inputs:
            action:
                description: "create or delete"
                required: true
                type: choice
                options:
                    - create
                    - delete

            repo_name:
                description: "GitHub repo name (e.g. python-fastapi-template)"
                required: true

            port:
                description: "Port (required only for create)"
                required: false

jobs:
    manage:
        runs-on: ubuntu-latest

        steps:
            - name: Execute on VM
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.VM_HOST }}
                  username: ${{ secrets.VM_USER }}
                  key: ${{ secrets.VM_SSH_KEY }}
                  script: |
                      set -e

                      ACTION="${{ github.event.inputs.action }}"
                      REPO="${{ github.event.inputs.repo_name }}"
                      PORT="${{ github.event.inputs.port }}"

                      if [ "$ACTION" = "create" ]; then
                        if [ -z "$PORT" ]; then
                          echo "‚ùå Port is required for create"
                          exit 1
                        fi
                        sudo /opt/automation/create_app.sh "$REPO" "$PORT"
                      fi

                      if [ "$ACTION" = "delete" ]; then
                        sudo /opt/automation/delete_app.sh "$REPO"
                      fi
